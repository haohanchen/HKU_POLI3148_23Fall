---
title: "Data Wrangling (1)"
author: "Haohan Chen"
date: "Last update: `r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document: default
  pdf_document: default
  md_document: default
knit: (function(inputFile, encoding){rmarkdown::render(inputFile, encoding = encoding, output_format = "all", knit_root_dir = getwd())})
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

## Objectives of this Lecture

This lecture introduces data wrangling with R. Using V-Dem data as an example, we will learn how to use the wrangle data with a set of [`tidyverse`](https://www.tidyverse.org/) functionality. Specifically, we will focus on functions...

1.  to import and export data: `read_csv` , `write_csv` (with a brief introduction to other data import/ export functions from [`readr`](https://readr.tidyverse.org/)).

2.  to take a subset of *columns* in the existing data: `select`

3.  to rename columns: `rename`

4.  to take a subset of *rows* by some simple conditions: `slice_`

5.  to take a subset of *rows* by some more complicated conditions: `filter`

6.  to sort the rows based on the value of one or multiple columns: `arrange`

7.  to perform (4) (5) (6) group by group: `group_by`, `ungroup`

8.  to create new columns in the data: `group_by`, `mutate`, `ungroup`

9.  to summarize the data: `group_by`, `summarise`, `ungroup`

## Outline of In-Class Demo

To demonstrate the above functionality, we will use real-world political data from [V-Dem](https://v-dem.net/). Specifically, we will use the above function to explore the state of global economic development from 1984 to 2022. Our effort will take the following step (with one-on-one mappings with the above tools).

1.  Read a part of pre-processed V-Dem data into R: 1984-2022 "external" data in the V-Dem dataset.
2.  Consulting the dataset's [codebook](https://github.com/haohanchen/HKU_POLI3148_23Fall/blob/main/_DataPublic_/vdem/documentation/codebook_v13.pdf) and take a **subset** of indicators of *economic development* (along with country-year identifiers).
    -   *See a list of country-yer identifiers on p. 5 of the codebook (under "1.7 Identifier Variables in the V-Dem Datasets").*

    -   *See a list of development indicators on p. 23 of the codebook (under "9. Background Factors").*
3.  Rename the column to name their names informative to readers.
4.  Find the country-year with the *highest* and *lowest* level of economic development. In addition, create a dataset containing a random sample of country-year in the dataset.
5.  Create a dataset focusing on the economic development of Asian countries and regions; Create a dataset that contains only countries/ regions whose development level pass certain threshold.
6.  Create a dataset whose rows are sorted by the development level of country-year.
7.  Create a dataset that contains the year of the higest development level for each country/ region respectively.
8.  Add the following economic indicators to the data:
    1.  Country-year development level with reference to that of 1984.

    2.  Year-on-year economic growth.
9.  Perform a data availability/ integrity check. Then aggregate the data into a new country-level dataset which contains the following indicators:
    1.  Average development level from 1984 to 2022.

    2.  Magnitude of growth from 1984 to 2022.

## In-Class Exercise

The quality of education has a decisive effect on a country's future development. Applying the data wrangling tools we introduce in this lecture, perform the following task:

1.  **Coodbook lookup**. Look up the codebook, answer the following questions:

    1.  What indicators regarding the quality of education are available in the V-Dem datasets? 9 Background Factors (E)

    9.1.1 Education 15+ (E) (e_peaveduc) What is the average years of education among citizens older than 15?

    9.1.2 Educational inequality, Gini (E) (e_peedgini) How unequal is the level of education achieved by the population aged 15 years and older?

    2.  What are the data's coverage (i.e., for which countries and years do we have data?)

    ```{r}
    setwd('C:/Users/warre/OneDrive/Documents/GitHub/HKU_POLI3148_23Fall/')
    set.seed(52)
    d <- read_csv("_DataPublic_/vdem/1984_2022/vdem_1984_2022_external.csv")
    d |> select(country_name, country_id, year) |> distinct()
    d |> select(country_name) |> distinct()
    d |> select(year) |> distinct()

    ```

    3.  What are their sources? Provide the link to least 1 source.

    e_peedgini: Source(s): Clio Infra (clio-infra.eu), drawing on Mitchell (1998a, 1998b, 1998c), United States Census Bureau (2021), UNESCO, Földvári and van Leeuwen (2010a), Leeuwen, van Leeuwen-Li, Földvári (2011), Leeuwen, van Leeuwen-Li, Földvári (2012a), Leeuwen, van Leeuwen-Li, Földvári (2012b), Didenko, Foldvari, van Leeuwen (2012).

2.  **Subset by columns**

    1.  Create a dataset containing only the country-year identifiers and indicators of education quality.

```{r}
education <- d |> select(country_name,  year, e_peaveduc, e_peedgini)

```

```         
2.  Rename the columns of education quality to make them informative.
```

```{r}
education_renamed <- education |> rename( "average_years_of_postsecondary_education" = "e_peaveduc" , "postsecondary_gini_inequality_index" = "e_peedgini" )
```

3.  **Subset by rows**

    1.  List 5 countries-years that have the highest education level among its population.

```{r}
education_renamed |> slice_max(average_years_of_postsecondary_education, n=5)
```

```         
2.  List 5 countries-years that suffer from the most severe inequality in education.
```

```{r}
education_renamed |> slice_max(postsecondary_gini_inequality_index, n=5)
```

4.  **Summarize the data**

    1.  Check data availability: For which countries and years are the indicators of education quality available?

```{r}
cleaned_data <- education_renamed |> filter_at(vars(c(postsecondary_gini_inequality_index, average_years_of_postsecondary_education)), any_vars(!is.na(.)))

education_renamed |> mutate(gini_missing = is.na(postsecondary_gini_inequality_index)) |> group_by(country_name) |>  summarize(number_missing_gini = sum(gini_missing))

education_renamed |> mutate(yrs_missing = is.na(average_years_of_postsecondary_education)) |> group_by(country_name) |>  summarize(number_missing_years_of_education = sum(yrs_missing))

summary(cleaned_data)

```

     
    2.  Create two types of country-level indicators of education quality

        1.  Average level of education quality from 1984 to 2022


```{r}
education_renamed |> group_by(country_name) |> summarise(avg_gini_index = mean(postsecondary_gini_inequality_index, na.rm = TRUE)) |> arrange(avg_gini_index)

education_renamed |> group_by(country_name) |> summarise(avg_gini_index = mean(postsecondary_gini_inequality_index, na.rm = TRUE)) |> arrange(-avg_gini_index)

education_renamed |> group_by(country_name) |> summarise(average_years_of_education = mean(average_years_of_postsecondary_education, na.rm = TRUE)) |> arrange(average_years_of_education)

education_renamed |> group_by(country_name) |> summarise(average_years_of_education = mean(average_years_of_postsecondary_education, na.rm = TRUE)) |> arrange(-average_years_of_education)
```

        2.  Change of education quality from 1984 to 2022

```{r}
education_renamed |> group_by(country_name) |> arrange(year, by.group=TRUE) |> mutate(change_in_years_of_education = last(average_years_of_postsecondary_education, year) - first(average_years_of_postsecondary_education, year), na.rm = TRUE) |> filter(year==2022) |> select(country_name, year, change_in_years_of_education) |> arrange(-change_in_years_of_education)

education_renamed |> group_by(country_name) |> arrange(year , by.group=TRUE) |> mutate(change_in_years_of_education = last(average_years_of_postsecondary_education, year) - first(average_years_of_postsecondary_education, year), na.rm = TRUE) |> filter(year==2022) |> select(country_name, year, change_in_years_of_education) |> arrange(change_in_years_of_education)

education_renamed   |> group_by(country_name) |> arrange(year) |> mutate(change= last(na.omit(postsecondary_gini_inequality_index)) - first(na.omit(postsecondary_gini_inequality_index))) |> filter(year==2022) |> select(country_name, year, change) |> arrange(-change)

education_renamed   |> group_by(country_name) |> arrange(year) |> mutate(change= last(na.omit(postsecondary_gini_inequality_index)) - first(na.omit(postsecondary_gini_inequality_index))) |> filter(year==2022) |> select(country_name, year, change) |> arrange(change)
```

        
    3.  Examine the data and *briefly* discuss: Which countries perform the best and the worst in terms of education quality in the past four decades?

African Nations generally do not see much education of individuals past the age of 15, where as Western developed nations sees higher education levels for individuals older than 15. Those same African nations also see a higher inequality, with a few very educated individuals and a lot of uneducated individuals. We see that Singapore and other developing Asian nations have seen higher growth of education level. However, in previous soviet states, the education years have gone down. This may be due to the following: while the soviets valued education, the value of education has become less relevant in the post soviet world as many states have become petro-states.

**Submission requirement:** You will submit your outputs through Moodle. In your submission:

1.  Attach a PDF document rendered by Rmarkdown
2.  In the text field of your submission, include the link to the corresponding Rmarkdown file in your *DaSPPA portfolio* GitHub repo.

**Due:** October 4, 2023

*Note:* *Please* *only use the functions we cover in this lecture for this exercise. There is [absolutely no need]{.underline} to perform any data visualization for this exercise... We will get there in later lectures.*

## Further reading

-   R for Data Science (2e) Chapters 4, 5, 8: <https://r4ds.hadley.nz/>

-   `readr` documentation (note: read the "cheatsheet"): <https://readr.tidyverse.org/>

-   `dplyr` documentation (note: read the "cheatsheet"): <https://dplyr.tidyverse.org/>

-   V-Dem documentation: <https://v-dem.net/>

## Demo